# Set another default user than root for security reasons
user  www-data www-data;
worker_processes  2;
#worker_rlimit_core  500M;
# Maximum file descriptors that can be opened per process. This should be > worker_connections
worker_rlimit_nofile 2048;

error_log  logs/error.log;
pid        logs/nginx.pid;

events {
    worker_connections  1024;
	use epoll;  # php-fpm friendly
    multi_accept on; # php-fpm friendly
}

#include /opt/verynginx/verynginx/nginx_conf/in_external.conf;

http {

	# http's cache block directives : top #

	keepalive_requests 100000;

	access_log off; 
	log_not_found off; 
    #access_log  logs/access.log  main; 
    
    proxy_cache_path /opt/openresty/nginx/cache/proxy  levels=1:2 keys_zone=proxy:10m max_size=1024m inactive=1h;
    
    proxy_buffers 256 16k; 
	proxy_buffer_size 128k; 
	proxy_connect_timeout 12s; 
	proxy_send_timeout 120s; 
	proxy_read_timeout 120s; 
	proxy_busy_buffers_size 256k; 
	proxy_temp_file_write_size 256k; 
	
	fastcgi_cache_path /opt/openresty/nginx/cache/fcgi levels=1:2 keys_zone=microcache:10m max_size=1024m inactive=1h;

	fastcgi_buffers 256 16k; 
	fastcgi_buffer_size 128k; 
	fastcgi_connect_timeout 12s; 
	fastcgi_send_timeout 120s; 
	fastcgi_read_timeout 120s; 
	fastcgi_busy_buffers_size 256k; 
	fastcgi_temp_file_write_size 256k; 

	reset_timedout_connection on; 
	server_names_hash_bucket_size 100;

	open_file_cache max=2000 inactive=60s; 
	open_file_cache_valid 60s; 
	open_file_cache_min_uses 2; 
	open_file_cache_errors off;

    gzip  on;
	gzip_disable "msie6"; 
	gzip_vary on; 
	gzip_proxied any; 
	gzip_comp_level 6; 
	gzip_min_length 1100; 
	gzip_buffers 16 8k; 
	gzip_http_version 1.1; 
	gzip_types text/plain text/css application/json application/javascript text/xml application/xml application/xml+rss text/javascript;

	# http's cache block directives : bot #

	# Hide nginx version information.
	server_tokens	off;

    include       	mime.types;
    default_type  	text/html; #application/octet-stream;

    log_format  main  '$remote_addr - $remote_user [$time_local] "$request" '
                      '$status $body_bytes_sent "$http_referer" '
                      '"$http_user_agent" "$http_x_forwarded_for"';

    sendfile        on;
    #tcp_nopush     on;

   	#keepalive_timeout  0;
    keepalive_timeout  65;

  	# powered by the nginx's redis native driver
	upstream redis_citalis {

		server 127.0.0.1:6379;
	   	# a pool with at most 1024 connections
	   	# and do not distinguish the servers:
	   	keepalive 1024;

	}
	
	# powered by the nginx's postgresql native driver as the most reliable one available
	upstream citalis {

		postgres_server 127.0.0.1 dbname=citalis user=plbc password=plbc;
		postgres_keepalive max=20 mode=single overflow=ignore;

	}

	#this line shoud be include in every http block
    #include /opt/verynginx/verynginx/nginx_conf/in_http_block.conf;

    server {
        listen       81 default_server deferred;
        server_name  localhost;

        #this line shoud be include in every server block
        #include /opt/verynginx/verynginx/nginx_conf/in_server_block.conf;

		# server's nocache block directives : top #

		set $cache_uri $request_uri;

		# POST requests and urls with a query string should always go to PHP
		if ($request_method = POST) {
			set $cache_uri 'null cache';
		}
		if ($query_string != "") {
			set $cache_uri 'null cache';
		}

		# Don't cache uris containing the following segments
		if ($request_uri ~* "(/wp-admin/|/xmlrpc.php|/wp-(app|cron|login|register|mail).php|wp-.*.php|/feed/|index.php|wp-comments-popup.php|wp-links-opml.php|wp-locations.php|sitemap(_index)?.xml|[a-z0-9_-]+-sitemap([0-9]+)?.xml)") {
			set $cache_uri 'null cache';
		}

		# Don't use the cache for logged in users or recent commenters
		if ($http_cookie ~* "comment_author|wordpress_[a-f0-9]+|wp-postpass|wordpress_logged_in") {
			set $cache_uri 'null cache';
		}

		# server's nocache block directives : bot #

        #Specify a charset
		charset utf-8;
	
		# fastcgi php-fpm support
		include php-fpm.conf;

		# openresty/db driven apps
		include nginx_pg_citalis.conf;
		include gunicorn-python-bottle.conf;
		include mono-fastcgi-server4.conf;
		include nodejs.conf;
		
		# nginx apache's reverse-proxy
		#include nginx_apache_proxy.conf;

		#access_log  logs/host1.access.log  main;

		#Enable ModSecurity 
		#ModSecurityEnabled off; 
		#ModSecurityConfig modsecurity.conf;

		root 	/var/www/html;
		index 	index.html;
		
        #location / {
        #    root   html;
        #    index  index.html index.htm;
        #}

        location ~* \.(js|css|png|jpg|jpeg|gif|ico)$ {
                expires 14d;
		}

        error_page  404              /404.html;
		error_page  403              /404.html; # intox

        # redirect server error pages to the static page /50x.html
        #
        error_page   500 502 503 504  /50x.html;
        location = /50x.html {
            root   html;
        }

		# deny access to .htaccess files, if Apache's document root concurs with nginx's one
		location ~ /\.ht {
			  deny  all;
		}

		### custom WAF - copyright 2016 Falko Timme : top ###
		### https://www.howtoforge.com/nginx-how-to-block-exploits-sql-injections-file-injections-spam-user-agents-etc ###

		## Block SQL injections
		set $block_sql_injections 0;
		if ($query_string ~ "union.*select.*\(") {
		    set $block_sql_injections 1;
		}
		if ($query_string ~ "union.*all.*select.*") {
		    set $block_sql_injections 1;
		}
		if ($query_string ~ "concat.*\(") {
		    set $block_sql_injections 1;
		}
		if ($block_sql_injections = 1) {
		    return 403;
		}

		## Block file injections
		set $block_file_injections 0;
		if ($query_string ~ "[a-zA-Z0-9_]=http://") {
		    set $block_file_injections 1;
		}
		if ($query_string ~ "[a-zA-Z0-9_]=(\.\.//?)+") {
		    set $block_file_injections 1;
		}
		if ($query_string ~ "[a-zA-Z0-9_]=/([a-z0-9_.]//?)+") {
		    set $block_file_injections 1;
		}
		if ($block_file_injections = 1) {
		    return 403;
		}

		## Block common exploits
		set $block_common_exploits 0;
		if ($query_string ~ "(<|%3C).*script.*(>|%3E)") {
		    set $block_common_exploits 1;
		}
		if ($query_string ~ "GLOBALS(=|\[|\%[0-9A-Z]{0,2})") {
		    set $block_common_exploits 1;
		}
		if ($query_string ~ "_REQUEST(=|\[|\%[0-9A-Z]{0,2})") {
		    set $block_common_exploits 1;
		}
		if ($query_string ~ "proc/self/environ") {
		    set $block_common_exploits 1;
		}
		if ($query_string ~ "mosConfig_[a-zA-Z_]{1,21}(=|\%3D)") {
		    set $block_common_exploits 1;
		}
		if ($query_string ~ "base64_(en|de)code\(.*\)") {
		    set $block_common_exploits 1;
		}
		if ($block_common_exploits = 1) {
		    return 403;
		}

		## Block spam
		set $block_spam 0;
		if ($query_string ~ "\b(ultram|unicauca|valium|viagra|vicodin|xanax|ypxaieo)\b") {
		    set $block_spam 1;
		}
		if ($query_string ~ "\b(erections|hoodia|huronriveracres|impotence|levitra|libido)\b") {
		    set $block_spam 1;
		}
		if ($query_string ~ "\b(ambien|blue\spill|cialis|cocaine|ejaculation|erectile)\b") {
		    set $block_spam 1;
		}
		if ($query_string ~ "\b(lipitor|phentermin|pro[sz]ac|sandyauer|tramadol|troyhamby)\b") {
		    set $block_spam 1;
		}
		if ($block_spam = 1) {
		    return 403;
		}

		## Block user agents
		set $block_user_agents 0;

		# Don't disable wget if you need it to run cron jobs!
		#if ($http_user_agent ~ "Wget") {
		#    set $block_user_agents 1;
		#}

		# Disable Akeeba Remote Control 2.5 and earlier
		if ($http_user_agent ~ "Indy Library") {
		    set $block_user_agents 1;
		}

		# Common bandwidth hoggers and hacking tools.
		if ($http_user_agent ~ "libwww-perl") {
		    set $block_user_agents 1;
		}
		if ($http_user_agent ~ "GetRight") {
		    set $block_user_agents 1;
		}
		if ($http_user_agent ~ "GetWeb!") {
		    set $block_user_agents 1;
		}
		if ($http_user_agent ~ "Go!Zilla") {
		    set $block_user_agents 1;
		}
		if ($http_user_agent ~ "Download Demon") {
		    set $block_user_agents 1;
		}
		if ($http_user_agent ~ "Go-Ahead-Got-It") {
		    set $block_user_agents 1;
		}
		if ($http_user_agent ~ "TurnitinBot") {
		    set $block_user_agents 1;
		}
		if ($http_user_agent ~ "GrabNet") {
		    set $block_user_agents 1;
		}

		if ($block_user_agents = 1) {
		    return 403;
		}

		### custom WAF - copyright 2016 Falko Timme : bot ###
		### https://www.howtoforge.com/nginx-how-to-block-exploits-sql-injections-file-injections-spam-user-agents-etc ###
    }

    # another virtual host using mix of IP-, name-, and port-based configuration
    #server {
    #    listen       8000;
    #    #listen       somename:8080;
    #    server_name  somename  alias  another.alias;

    #    location / {
    #        root   html;
    #        index  index.html index.htm;
    #    }
    #}

    # HTTPS server
    #
    server {

        listen       443 ssl;
        server_name  localhost;

		#access_log  logs/host2.access.log  main;

        ssl_certificate      server.crt;
        ssl_certificate_key  server.key;

        ssl_session_cache    shared:SSL:10m;
        ssl_session_timeout  10m;

        ssl_ciphers  HIGH:!aNULL:!MD5;
        ssl_prefer_server_ciphers  on;

        #Specify a charset
		charset utf-8;
	
		# fastcgi php-fpm support
		include php-fpm.conf;

		# openresty/db driven apps
		include nginx_pg_citalis.conf;

		root 	/var/www/html;
		index 	index.html;

		# activation module ngx_http_auth_basic_module : top #
		# contexte : http, server, location, limit_except
    	auth_basic           	"Restricted Content";
    	auth_basic_user_file 	/opt/openresty/nginx/conf/.htpasswd;
		# activation module ngx_http_auth_basic_module : bot #

        #location / {
        #    root   html;
        #    index  index.html index.htm;
        #}

        location ~* \.(js|css|png|jpg|jpeg|gif|ico)$ {
                expires 14d;
		}

		error_page  404              /404.html;
		error_page  403              /404.html; # intox

        # redirect server error pages to the static page /50x.html
        #
        error_page   500 502 503 504  /50x.html;
        location = /50x.html {
            root   html;
        }

		# deny access to .htaccess files, if Apache's document root concurs with nginx's one
		location ~ /\.ht {
			  deny  all;
		}

		### custom WAF - copyright 2016 Falko Timme : top ###
		### https://www.howtoforge.com/nginx-how-to-block-exploits-sql-injections-file-injections-spam-user-agents-etc ###

		## Block SQL injections
		set $block_sql_injections 0;
		if ($query_string ~ "union.*select.*\(") {
		    set $block_sql_injections 1;
		}
		if ($query_string ~ "union.*all.*select.*") {
		    set $block_sql_injections 1;
		}
		if ($query_string ~ "concat.*\(") {
		    set $block_sql_injections 1;
		}
		if ($block_sql_injections = 1) {
		    return 403;
		}

		## Block file injections
		set $block_file_injections 0;
		if ($query_string ~ "[a-zA-Z0-9_]=http://") {
		    set $block_file_injections 1;
		}
		if ($query_string ~ "[a-zA-Z0-9_]=(\.\.//?)+") {
		    set $block_file_injections 1;
		}
		if ($query_string ~ "[a-zA-Z0-9_]=/([a-z0-9_.]//?)+") {
		    set $block_file_injections 1;
		}
		if ($block_file_injections = 1) {
		    return 403;
		}

		## Block common exploits
		set $block_common_exploits 0;
		if ($query_string ~ "(<|%3C).*script.*(>|%3E)") {
		    set $block_common_exploits 1;
		}
		if ($query_string ~ "GLOBALS(=|\[|\%[0-9A-Z]{0,2})") {
		    set $block_common_exploits 1;
		}
		if ($query_string ~ "_REQUEST(=|\[|\%[0-9A-Z]{0,2})") {
		    set $block_common_exploits 1;
		}
		if ($query_string ~ "proc/self/environ") {
		    set $block_common_exploits 1;
		}
		if ($query_string ~ "mosConfig_[a-zA-Z_]{1,21}(=|\%3D)") {
		    set $block_common_exploits 1;
		}
		if ($query_string ~ "base64_(en|de)code\(.*\)") {
		    set $block_common_exploits 1;
		}
		if ($block_common_exploits = 1) {
		    return 403;
		}

		## Block spam
		set $block_spam 0;
		if ($query_string ~ "\b(ultram|unicauca|valium|viagra|vicodin|xanax|ypxaieo)\b") {
		    set $block_spam 1;
		}
		if ($query_string ~ "\b(erections|hoodia|huronriveracres|impotence|levitra|libido)\b") {
		    set $block_spam 1;
		}
		if ($query_string ~ "\b(ambien|blue\spill|cialis|cocaine|ejaculation|erectile)\b") {
		    set $block_spam 1;
		}
		if ($query_string ~ "\b(lipitor|phentermin|pro[sz]ac|sandyauer|tramadol|troyhamby)\b") {
		    set $block_spam 1;
		}
		if ($block_spam = 1) {
		    return 403;
		}

		## Block user agents
		set $block_user_agents 0;

		# Don't disable wget if you need it to run cron jobs!
		#if ($http_user_agent ~ "Wget") {
		#    set $block_user_agents 1;
		#}

		# Disable Akeeba Remote Control 2.5 and earlier
		if ($http_user_agent ~ "Indy Library") {
		    set $block_user_agents 1;
		}

		# Common bandwidth hoggers and hacking tools.
		if ($http_user_agent ~ "libwww-perl") {
		    set $block_user_agents 1;
		}
		if ($http_user_agent ~ "GetRight") {
		    set $block_user_agents 1;
		}
		if ($http_user_agent ~ "GetWeb!") {
		    set $block_user_agents 1;
		}
		if ($http_user_agent ~ "Go!Zilla") {
		    set $block_user_agents 1;
		}
		if ($http_user_agent ~ "Download Demon") {
		    set $block_user_agents 1;
		}
		if ($http_user_agent ~ "Go-Ahead-Got-It") {
		    set $block_user_agents 1;
		}
		if ($http_user_agent ~ "TurnitinBot") {
		    set $block_user_agents 1;
		}
		if ($http_user_agent ~ "GrabNet") {
		    set $block_user_agents 1;
		}

		if ($block_user_agents = 1) {
		    return 403;
		}

		### custom WAF - copyright 2016 Falko Timme : bot ###
		### https://www.howtoforge.com/nginx-how-to-block-exploits-sql-injections-file-injections-spam-user-agents-etc ###

    }

}
